(()=>{"use strict";var t={d:(e,r)=>{for(var i in r)t.o(r,i)&&!t.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:r[i]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)};function e(t,e,r){const i=Math.atan2(t.y,t.x)<0?Math.abs(Math.atan2(t.y,t.x)):2*Math.PI-Math.atan2(t.y,t.x);if(Math.sqrt(t.x*t.x+t.y*t.y)>e)switch(!0){case i<=Math.PI/4||i>7*Math.PI/4:r("right");break;case i<=3*Math.PI/4:r("up");break;case i<=5*Math.PI/4:r("left");break;case i<=7*Math.PI/4:r("down")}}t.d({},{IY:()=>m,hy:()=>W,Sr:()=>v});class r{constructor({boardBackgroundColor:t,boardInnerStartX:e,boardInnerStartY:r,boardWidth:i,boardHeight:o,borderRadius:s,borderColor:n,borderWidth:h,boardPadding:a,boardGap:d,tileWidth:l,tileHeight:c,ctx:_}){this._boardBackgroundColor=t,this._boardInnerStartX=e,this._boardInnerStartY=r,this._boardWidth=i,this._boardHeight=o,this._borderRadius=s,this._borderColor=n,this._borderWidth=h,this._boardPadding=a,this._boardGap=d,this._tileWidth=l,this._tileHeight=c,this._ctx=_}draw(){this._ctx.strokeStyle=this._borderColor,this._ctx.beginPath(),this._ctx.roundRect(this._boardInnerStartX,this._boardInnerStartY,this._boardWidth,this._boardHeight,this._borderRadius),this._ctx.fillStyle=this._boardBackgroundColor,this._ctx.fill(),this._ctx.lineWidth=this._borderWidth,this._ctx.stroke(),this._ctx.closePath()}getPositionOnBoardByRowAndCol(t,e){return{x:this._boardInnerStartX+this._boardPadding+e*(this._tileWidth+this._boardGap),y:this._boardInnerStartY+this._boardPadding+t*(this._tileHeight+this._boardGap)}}}class i{constructor({scoreBackgroundColor:t,scoreInnerStartX:e,scoreInnerStartY:r,scoreWidth:i,scoreHeight:o,borderColor:s,borderWidth:n,font:h,textColor:a,textVerticalAdjustment:d,ctx:l}){this._scoreBackgroundColor=t,this._scoreInnerStartX=e,this._scoreInnerStartY=r,this._scoreWidth=i,this._scoreHeight=o,this._borderColor=s,this._borderWidth=n,this._font=h,this._textColor=a,this._textVerticalAdjustment=d,this._ctx=l}draw(t){this._ctx.strokeStyle=this._borderColor,this._ctx.beginPath(),this._ctx.roundRect(this._scoreInnerStartX,this._scoreInnerStartY,this._scoreWidth,this._scoreHeight,"50"),this._ctx.fillStyle=this._scoreBackgroundColor,this._ctx.fill(),this._ctx.lineWidth=this._borderWidth,this._ctx.stroke(),this._ctx.font=this._font,this._ctx.textAlign="center",this._ctx.textBaseline="middle",this._ctx.fillStyle=this._textColor,this._ctx.fillText("СЧЁТ: "+t,this._scoreInnerStartX+this._scoreWidth/2,this._scoreInnerStartY+this._scoreHeight/2+this._textVerticalAdjustment)}}class o{constructor(t,e){this._score=0,this._tilesCount=0,this._tilemap=[],this._isMoved=!1,this._max=2;for(let r=0;r<t;r++){this._tilemap.push([]);for(let t=0;t<e;t++)this._tilemap[r].push(null)}this._shadowTiles=[],this._isMoving=!1}getScore(){return this._score}setScore(t){this._score=t}getTilesCount(){return this._tilesCount}setTilesCount(t){this._tilesCount=t}incTilesCount(){this._tilesCount+=1}getIsMoving(){return this._isMoving}setIsMoving(t){this._isMoving=t}getShadowTiles(){return this._shadowTiles}pushToShadowTiles(t){this._shadowTiles.push(t)}clearShadowTiles(){this._shadowTiles=[]}getTileMap(){return this._tilemap}setItemInTileMap(t,e,r){this._tilemap[t][e]=r}getIsMoved(){return this._isMoved}setIsMoved(t){this._isMoved=t}getMax(){return this._max}setMaxIfGreater(t){this._max<t&&(this._max=t)}}const s="#EEE4DA",n="#EEE0C6",h="#F9B377",a="#FF9B60",d="#CA6A48",l="#EC6233",c="#E8C462",_="#E0BA55",g="#F3C54B",u="#F2C138",b="#F3BD29";function x(t){switch(t){case 2:return s;case 4:return n;case 8:return h;case 16:return a;case 32:return d;case 64:return l;case 128:return c;case 256:return _;case 512:return g;case 1024:return u;default:return b}}function C({currentTile:t,checkWith:e,row:r,col:i,setRow:o,setCol:s,setCheckWith:n,setCurrentTile:h}){null!==t&&(v.setIsMoving(!0),!e||t.getValue()!==e.getValue()||t.getIsMerged()||e.getIsMerged()?null===e&&(t.setRowAndCol(r,i),n(t),h(null),o(),s(),v.setIsMoved(!0)):(t.setRowAndCol(r,i),e.setRowAndCol(r,i),e.setIsMerged(!0),v.pushToShadowTiles(t),h(null),e.setValue(2*e.getValue()),v.setMaxIfGreater(e.getValue()),e.setColor(x(e.getValue())),v.setScore(v.getScore()+e.getValue()),v.setTilesCount(v.getTilesCount()-1),v.setIsMoved(!0)))}class M{constructor({updatesPerSecond:t,gameBackgroundColor:e,borderColor:r,borderWidth:i,borderRadius:o,boardBackgroundColor:s,scoreBackgroundColor:n,textColor:h,canvasPadding:a,boardGap:d,boardPadding:l,scoreMargin:c,scorePadding:_,fontSize:g,textVerticalAdjustment:u,rows:b,cols:x,tileWidth:C,tileHeight:M,scoreWidth:f}){this._updatesPerSecond=t,this._gameBackgroundColor=e,this._borderColor=r,this._borderWidth=i,this._borderRadius=o,this._boardBackgroundColor=s,this._scoreBackgroundColor=n,this._textColor=h,this._canvasPadding=a,this._boardGap=d,this._boardPadding=l,this._scoreMargin=c,this._scorePadding=_,this._fontSize=g,this._textVerticalAdjustment=u,this._rows=b,this._cols=x,this._tileWidth=C,this._tileHeight=M,this._scoreWidth=f,this._font=this._fontSize+"px serif",this._boardWidth=this._cols*this._tileWidth+(this._cols-1)*this._boardGap+2*this._boardPadding,this._boardHeight=this._rows*this._tileWidth+(this._rows-1)*this._boardGap+2*this._boardPadding,this._scoreHeight=this._fontSize+2*this._borderWidth+2*this._scorePadding,this._scoreInnerStartX=this._canvasPadding+this._borderWidth+(this._boardWidth-this._scoreWidth)/2,this._scoreInnerStartY=this._canvasPadding+this._borderWidth,this._boardInnerStartX=this._canvasPadding+this._borderWidth,this._boardInnerStartY=this._canvasPadding+this._borderWidth+this._scoreHeight+this._scoreMargin}get updatesPerSecond(){return this._updatesPerSecond}get gameBackgroundColor(){return this._gameBackgroundColor}get borderColor(){return this._borderColor}get borderWidth(){return this._borderWidth}get borderRadius(){return this._borderRadius}get boardBackgroundColor(){return this._boardBackgroundColor}get scoreBackgroundColor(){return this._scoreBackgroundColor}get textColor(){return this._textColor}get canvasPadding(){return this._canvasPadding}get boardGap(){return this._boardGap}get boardPadding(){return this._boardPadding}get scoreMargin(){return this._scoreMargin}get font(){return this._font}get textVerticalAdjustment(){return this._textVerticalAdjustment}get rows(){return this._rows}get cols(){return this._cols}get tileWidth(){return this._tileWidth}get tileHeight(){return this._tileHeight}get boardWidth(){return this._boardWidth}get boardHeight(){return this._boardHeight}get scoreWidth(){return this._scoreWidth}get scoreHeight(){return this._scoreHeight}get scoreInnerStartX(){return this._scoreInnerStartX}get scoreInnerStartY(){return this._scoreInnerStartY}get boardInnerStartX(){return this._boardInnerStartX}get boardInnerStartY(){return this._boardInnerStartY}}class f{constructor({color:t,value:e,ctx:r,row:i,col:o,width:s,height:n,radius:h,position:a,font:d}){this._color=t,this._value=e,this._ctx=r,this._row=i,this._col=o,this._width=s,this._height=n,this._isMerged=!1,this._isMoving=!1,this._radius=h,this._position={x:a.x,y:a.y},this._font={font:d.font,textColor:d.textColor,textVerticalAdjustment:d.textVerticalAdjustment},this._prevPosition={x:a.x,y:a.y}}getIsMoving(){return this._isMoving}getColumn(){return this._col}getRow(){return this._row}getValue(){return this._value}setValue(t){this._value=t}getIsMerged(){return this._isMerged}setIsMerged(t){this._isMerged=t}setColor(t){this._color=t}setRowAndCol(t,e){this._row=t,this._col=e}draw(){this._ctx.fillStyle=this._color,this._ctx.beginPath(),this._ctx.roundRect(this._position.x,this._position.y,this._width,this._height,this._radius),this._ctx.fill(),this._ctx.font=this._font.font,this._ctx.textAlign="center",this._ctx.textBaseline="middle",this._ctx.fillStyle=this._font.textColor,this._ctx.fillText(this._value,this._position.x+this._width/2,this._position.y+ +this._height/2+this._font.textVerticalAdjustment),this._ctx.closePath()}move(t,e){if(Math.abs(this._prevPosition.x-this._position.x)>=Math.abs(t-this._prevPosition.x)&&Math.abs(this._prevPosition.y-this._position.y)>=Math.abs(e-this._prevPosition.y))return this._prevPosition.x=t,this._prevPosition.y=e,this._position.x=t,this._position.y=e,this.draw(),void(this._isMoving&&(this._isMoving=!1));this._isMoving=!0,this._position.x+=(t-this._prevPosition.x)/5,this._position.y+=(e-this._prevPosition.y)/5,this.draw()}}function p(t,e,r=!1){let i;i=r?2:Math.random()>=.9?4:2,function r(){let o=Math.floor(Math.random()*W.rows),s=Math.floor(Math.random()*W.cols);null===v.getTileMap()[o][s]?(v.incTilesCount(),v.setItemInTileMap(o,s,new f({width:W.tileWidth,height:W.tileHeight,col:s,row:o,color:x(i),value:i,ctx:e,position:t(o,s),font:{font:W.font,textColor:W.textColor,textVerticalAdjustment:W.textVerticalAdjustment},radius:W.borderRadius}))):v.getTileMap().some((t=>t.some((t=>null===t))))?r():console.log("full")}()}function w(t){t.forEach((t=>{if(t instanceof Array)t.forEach((t=>{if(t){const e=m.getPositionOnBoardByRowAndCol(t.getRow(),t.getColumn());t.move(e.x,e.y)}}));else{const e=m.getPositionOnBoardByRowAndCol(t.getRow(),t.getColumn());t.move(e.x,e.y)}}))}const I=document.querySelector("#game"),S=I.getContext("2d");let W,v,m,T;function P(){W=new M({updatesPerSecond:60,gameBackgroundColor:"#FFFFFF",borderColor:"#949494",borderWidth:3,borderRadius:4,boardBackgroundColor:"#D0C0AF",scoreBackgroundColor:"#DADADA",textColor:"#010101",canvasPadding:10,boardGap:10,boardPadding:15,scoreMargin:20,scorePadding:12,fontSize:32,textVerticalAdjustment:3,rows:4,cols:4,tileWidth:80,tileHeight:80,scoreWidth:270}),v=new o(W.rows,W.cols),m=new r({boardBackgroundColor:W.boardBackgroundColor,boardInnerStartX:W.boardInnerStartX,boardInnerStartY:W.boardInnerStartY,boardWidth:W.boardWidth,boardHeight:W.boardHeight,borderRadius:W.borderRadius,borderColor:W.borderColor,borderWidth:W.borderWidth,boardPadding:W.boardPadding,boardGap:W.boardGap,tileWidth:W.tileWidth,tileHeight:W.tileHeight,ctx:S}),T=new i({scoreBackgroundColor:W.scoreBackgroundColor,scoreInnerStartX:W.scoreInnerStartX,scoreInnerStartY:W.scoreInnerStartY,scoreWidth:W.scoreWidth,scoreHeight:W.scoreHeight,borderColor:W.borderColor,borderWidth:W.borderWidth,font:W.font,textColor:W.textColor,score:v.getScore(),textVerticalAdjustment:W.textVerticalAdjustment,ctx:S}),I.width=W.boardWidth+2*W.borderWidth+2*W.canvasPadding,I.height=W.boardHeight+2*W.borderWidth+2*W.canvasPadding+W.scoreHeight+W.scoreMargin,S.fillStyle=W.gameBackgroundColor,S.fillRect(0,0,I.width,I.height),p(((t,e)=>m.getPositionOnBoardByRowAndCol(t,e)),S,!0),p(((t,e)=>m.getPositionOnBoardByRowAndCol(t,e)),S,!0),window.requestAnimationFrame(k)}P();let y=0;function k(t){window.requestAnimationFrame(k),(t-y)/1e3>=1/W.updatesPerSecond&&(m.draw(),T.draw(v.getScore()),w(v.getShadowTiles()),w(v.getTileMap()),v.getIsMoving()&&!(v.getTileMap().some((t=>t.some((t=>t&&t.getIsMoving()))))||v.getShadowTiles().some((t=>t&&t.getIsMoving())))&&(v.setIsMoving(!1),v.clearShadowTiles(),v.getIsMoved()&&(p(((t,e)=>m.getPositionOnBoardByRowAndCol(t,e)),S),v.setIsMoved(!1),v.getMax()>=2048&&(w(v.getTileMap()),setTimeout((()=>{alert("Уровень пройден"),P()}))),v.getTilesCount()>=W.rows*W.cols&&function(){for(let t=0;t<v.getTileMap().length;t++)for(let e=0;e<v.getTileMap()[t].length;e++)if(void 0!==v.getTileMap()[t][e+1]&&v.getTileMap()[t][e].getValue()===v.getTileMap()[t][e+1].getValue()||void 0!==v.getTileMap()[t+1]&&void 0!==v.getTileMap()[t+1][e]&&v.getTileMap()[t][e].getValue()===v.getTileMap()[t+1][e].getValue())return!1;return!0}()&&(w(v.getTileMap()),setTimeout((()=>{alert("Нельзя сделать ход»"),P()}))))),y=t)}!function(t,r){let i=!1,o={x:0,y:0},s={x:0,y:0},n={x:0,y:0};function h(t,e){o.x=t,o.y=e}function a(t,e){s.x=t,s.y=e,n.x=s.x-o.x,n.y=s.y-o.y}t.addEventListener("touchstart",(t=>{h(t.changedTouches[0].clientX,t.changedTouches[0].clientY)})),t.addEventListener("touchend",(t=>{a(t.changedTouches[0].clientX,t.changedTouches[0].clientY),e(n,100,r)})),t.addEventListener("mousedown",(t=>{h(t.clientX,t.clientY),i=!0})),t.addEventListener("mouseup",(t=>{i&&(a(t.clientX,t.clientY),e(n,100,r),i=!1)})),t.addEventListener("mouseout",(t=>{i&&(a(t.clientX,t.clientY),e(n,100,r),i=!1)}))}(I,(t=>{v.getIsMoving()||function({dir:t,rows:e,cols:r,tilemap:i,setTileInTileMap:o}){switch(t){case"up":for(let t=1;t<e;t++)for(let e=0;e<r;e++)C({currentTile:i[t][e],checkWith:i[t-1][e],row:t-1,col:e,setRow:()=>t=1,setCol:()=>e-=1,setCheckWith:r=>o(t-1,e,r),setCurrentTile:r=>o(t,e,r)});break;case"left":for(let t=1;t<r;t++)for(let r=0;r<e;r++)C({currentTile:i[r][t],checkWith:i[r][t-1],row:r,col:t-1,setRow:()=>r--,setCol:()=>t=1,setCheckWith:e=>o(r,t-1,e),setCurrentTile:e=>o(r,t,e)});break;case"down":for(let t=e-2;t>=0;t--)for(let s=r-1;s>=0;s--)C({currentTile:i[t][s],checkWith:i[t+1][s],row:t+1,col:s,setRow:()=>t=e-2,setCol:()=>s++,setCheckWith:e=>o(t+1,s,e),setCurrentTile:e=>o(t,s,e)});break;case"right":for(let t=r-2;t>=0;t--)for(let s=e-1;s>=0;s--)C({currentTile:i[s][t],checkWith:i[s][t+1],row:s,col:t+1,setRow:()=>s++,setCol:()=>t=r-2,setCheckWith:e=>o(s,t+1,e),setCurrentTile:e=>o(s,t,e)})}v.getTileMap().forEach((t=>{t.forEach((t=>{t&&t.setIsMerged(!1)}))}))}({dir:t,rows:W.rows,cols:W.cols,tilemap:v.getTileMap(),setTileInTileMap:(t,e,r)=>v.setItemInTileMap(t,e,r)})}))})();